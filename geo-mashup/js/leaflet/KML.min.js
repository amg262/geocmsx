L.KML=L.FeatureGroup.extend({options:{async:true},initialize:function(a,b){L.Util.setOptions(this,b);this._kml=a;this._layers={};if(a){this.addKML(a,b,this.options.async)}},loadXML:function(c,a,b,d){if(d==undefined){d=this.options.async}if(b==undefined){b=this.options}var f=new window.XMLHttpRequest();f.open("GET",c,d);try{f.overrideMimeType("text/xml")}catch(g){}f.onreadystatechange=function(){if(f.readyState!=4){return}if(f.status==200){a(f.responseXML,b)}};f.send(null)},addKML:function(c,b,d){var e=this;var a=function(g,f){e._addKML(g,f)};this.loadXML(c,a,b,d)},_addKML:function(b,a){var d=L.KML.parseKML(b);if(!d||!d.length){return}for(var c=0;c<d.length;c++){this.fire("addlayer",{layer:d[c]});this.addLayer(d[c])}this.latLngs=L.KML.getLatLngs(b);this.fire("loaded")},latLngs:[]});L.Util.extend(L.KML,{parseKML:function(c){var f=this.parseStyle(c);this.parseStyleMap(c,f);var e=c.getElementsByTagName("Folder");var g=[],a;for(var d=0;d<e.length;d++){if(!this._check_folder(e[d])){continue}a=this.parseFolder(e[d],f);if(a){g.push(a)}}e=c.getElementsByTagName("Placemark");for(var b=0;b<e.length;b++){if(!this._check_folder(e[b])){continue}a=this.parsePlacemark(e[b],c,f);if(a){g.push(a)}}return g},_check_folder:function(b,a){b=b.parentElement;while(b&&b.tagName!=="Folder"){b=b.parentElement}return !b||b===a},parseStyle:function(h){var b={};var d=h.getElementsByTagName("Style");var f={color:true,width:true,Icon:true,href:true,hotSpot:true};function j(p){var o={};for(var r=0;r<p.childNodes.length;r++){var t=p.childNodes[r];var q=t.tagName;if(!f[q]){continue}if(q==="hotSpot"){for(var n=0;n<t.attributes.length;n++){o[t.attributes[n].name]=t.attributes[n].nodeValue}}else{var s=t.childNodes[0].nodeValue;if(q==="color"){o.opacity=parseInt(s.substring(0,2),16)/255;o.color="#"+s.substring(6,8)+s.substring(4,6)+s.substring(2,4)}else{if(q==="width"){o.weight=s}else{if(q==="Icon"){a=j(t);if(a.href){o.href=a.href}}else{if(q==="href"){o.href=s}}}}}}return o}for(var g=0;g<d.length;g++){var k=d[g],c;var m={},l={},a={};c=k.getElementsByTagName("LineStyle");if(c&&c[0]){m=j(c[0])}c=k.getElementsByTagName("PolyStyle");if(c&&c[0]){l=j(c[0])}if(l.color){m.fillColor=l.color}if(l.opacity){m.fillOpacity=l.opacity}c=k.getElementsByTagName("IconStyle");if(c&&c[0]){a=j(c[0])}if(a.href){m.icon=new L.KMLIcon({iconUrl:a.href,shadowUrl:null,iconAnchorRef:{x:a.x,y:a.y},iconAnchorType:{x:a.xunits,y:a.yunits}})}b["#"+k.getAttribute("id")]=m}return b},parseStyleMap:function(f,d){var b=f.getElementsByTagName("StyleMap");for(var g=0;g<b.length;g++){var j=b[g],h;var a,c;h=j.getElementsByTagName("key");if(h&&h[0]){a=h[0].textContent}h=j.getElementsByTagName("styleUrl");if(h&&h[0]){c=h[0].textContent}if(a=="normal"){d["#"+j.getAttribute("id")]=d[c]}}return},parseFolder:function(c,f){var e,g=[],a;e=c.getElementsByTagName("Folder");for(var d=0;d<e.length;d++){if(!this._check_folder(e[d],c)){continue}a=this.parseFolder(e[d],f);if(a){g.push(a)}}e=c.getElementsByTagName("Placemark");for(var b=0;b<e.length;b++){if(!this._check_folder(e[b],c)){continue}a=this.parsePlacemark(e[b],c,f);if(a){g.push(a)}}if(!g.length){return}if(g.length===1){return g[0]}return new L.FeatureGroup(g)},parsePlacemark:function(h,o,c){var n,k,e,t={};e=h.getElementsByTagName("styleUrl");for(n=0;n<e.length;n++){var d=e[n].childNodes[0].nodeValue;for(var r in c[d]){if(true){t[r]=c[d][r]}}}var m=[];var g=["LineString","Polygon","Point"];for(k in g){if(true){var s=g[k];e=h.getElementsByTagName(s);for(n=0;n<e.length;n++){var f=this["parse"+s](e[n],o,t);if(f){m.push(f)}}}}if(!m.length){return}var p=m[0];if(m.length>1){p=new L.FeatureGroup(m)}var b,q="";e=h.getElementsByTagName("name");if(e.length&&e[0].childNodes.length){b=e[0].childNodes[0].nodeValue}e=h.getElementsByTagName("description");for(n=0;n<e.length;n++){for(k=0;k<e[n].childNodes.length;k++){q=q+e[n].childNodes[k].nodeValue}}if(b){p.bindPopup("<h2>"+b+"</h2>"+q)}return p},parseCoords:function(a){var b=a.getElementsByTagName("coordinates");return this._read_coords(b[0])},parseLineString:function(a,c,b){var d=this.parseCoords(a);if(!d.length){return}return new L.Polyline(d,b)},parsePoint:function(a,c,b){var d=a.getElementsByTagName("coordinates");if(!d.length){return}var e=d[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(e[1],e[0]),b)},parsePolygon:function(b,e,d){var g,a=[],c=[],f,h;g=b.getElementsByTagName("outerBoundaryIs");for(f=0;f<g.length;f++){h=this.parseCoords(g[f]);if(h){a.push(h)}}g=b.getElementsByTagName("innerBoundaryIs");for(f=0;f<g.length;f++){h=this.parseCoords(g[f]);if(h){c.push(h)}}if(!a.length){return}if(d.fillColor){d.fill=true}if(a.length===1){return new L.Polygon(a.concat(c),d)}return new L.MultiPolygon(a,d)},getLatLngs:function(b){var c=b.getElementsByTagName("coordinates");var d=[];for(var a=0;a<c.length;a++){d=d.concat(this._read_coords(c[a]))}return d},_read_coords:function(b){var e="",c=[],a;for(a=0;a<b.childNodes.length;a++){e=e+b.childNodes[a].nodeValue}e=e.split(/[\s\n]+/);for(a=0;a<e.length;a++){var d=e[a].split(",");if(d.length<2){continue}c.push(new L.LatLng(d[1],d[0]))}return c}});L.KMLIcon=L.Icon.extend({createIcon:function(){var a=this._createIcon("icon");a.onload=function(){var b=a;this.style.width=b.width+"px";this.style.height=b.height+"px";if(this.anchorType.x==="UNITS_FRACTION"||this.anchorType.x==="fraction"){a.style.marginLeft=(-this.anchor.x*b.width)+"px"}if(this.anchorType.y==="UNITS_FRACTION"||this.anchorType.x==="fraction"){a.style.marginTop=(-(1-this.anchor.y)*b.height)+"px"}this.style.display=""};return a},_setIconStyles:function(a,b){L.Icon.prototype._setIconStyles.apply(this,[a,b]);a.anchor=this.options.iconAnchorRef;a.anchorType=this.options.iconAnchorType}});L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default()}});